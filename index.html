<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta name="robots" content="noindex, nofollow" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Patrimonio Pro - Dashboard Finanziaria</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
      .card-enter {
        animation: fadeInUp 0.4s ease-out;
      }
      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .glass {
        background: rgba(30, 41, 59, 0.7);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      body {
        background-color: #0b1120;
      }
    </style>
  </head>
  <body class="text-slate-200 p-4 md:p-8 font-sans">
    <div id="app" class="max-w-6xl mx-auto hidden">
      <header
        class="mb-10 flex flex-col md:flex-row justify-between items-center gap-6 glass p-8 rounded-[2rem]"
      >
        <div>
          <h1
            class="text-3xl font-black text-white tracking-tight italic uppercase flex items-center gap-3"
          >
            <span class="text-emerald-400">ðŸ’°</span> Portfolio & Cashflow
          </h1>
          <div
            id="totale-display"
            class="mt-2 text-4xl font-black tracking-tighter text-white"
          >
            Calcolo...
          </div>
          <div id="riepilogo-titolari" class="mt-4 flex flex-wrap gap-3"></div>
        </div>
        <button
          onclick="toggleForm()"
          class="bg-emerald-500 hover:bg-emerald-400 text-white px-8 py-4 rounded-2xl font-black transition-all shadow-lg active:scale-95"
        >
          + AGGIUNGI ASSET
        </button>
      </header>

      <section class="mb-12 glass rounded-[2rem] p-8">
        <h2
          class="text-xs font-black text-slate-400 mb-6 uppercase tracking-[0.3em] flex items-center gap-3"
        >
          <svg
            class="w-5 h-5 text-amber-500"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
            ></path>
          </svg>
          Prossimi Incassi Cedole (Netto 12.5%)
        </h2>
        <div
          id="cashflow-container"
          class="grid grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4"
        ></div>
      </section>

      <div id="wrapper-investimenti" class="mb-16">
        <h2
          class="text-xs font-black text-blue-400 mb-6 uppercase tracking-[0.3em] flex items-center gap-3"
        >
          <svg
            class="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"
            ></path>
          </svg>
          Titoli e Investimenti (BTP / Azioni)
        </h2>
        <div
          id="grid-container"
          class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"
        ></div>
      </div>

      <div id="wrapper-conti" class="mb-20">
        <h2
          class="text-xs font-black text-purple-400 mb-6 uppercase tracking-[0.3em] flex items-center gap-3"
        >
          <svg
            class="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"
            ></path>
          </svg>
          Conti Correnti e LiquiditÃ 
        </h2>
        <div
          id="conti-container"
          class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"
        ></div>
      </div>

      <div
        id="form-aggiunta"
        class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-950/90 backdrop-blur-sm"
      >
        <div
          class="bg-slate-800 p-8 rounded-[2rem] border border-slate-700 w-full max-w-2xl shadow-2xl"
        >
          <h2 class="text-2xl font-black mb-6 text-white uppercase italic">
            Nuovo Asset
          </h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <input
              type="text"
              id="new-nome"
              placeholder="Nome (es. BTP VALORE)"
              class="bg-slate-900 border border-slate-700 p-4 rounded-xl text-white"
            />
            <input
              type="text"
              id="new-isin"
              placeholder="ISIN"
              class="bg-slate-900 border border-slate-700 p-4 rounded-xl text-white font-mono uppercase"
            />
            <select
              id="new-titolare"
              class="bg-slate-900 border border-slate-700 p-4 rounded-xl text-white font-bold"
            >
              <option value="CLARA">CLARA</option>
              <option value="FEDERICO">FEDERICO</option>
              <option value="ANTONELLA">ANTONELLA</option>
            </select>
            <input
              type="number"
              step="0.01"
              id="new-cedola"
              placeholder="Cedola Annua %"
              class="bg-slate-900 border border-slate-700 p-4 rounded-xl text-white"
            />
            <input
              type="text"
              id="new-mesi"
              placeholder="Mesi Stacco (es. 05,11)"
              class="bg-slate-900 border border-slate-700 p-4 rounded-xl text-white"
            />
            <input
              type="number"
              step="0.01"
              id="new-carico"
              placeholder="Prezzo Carico"
              class="bg-slate-900 border border-slate-700 p-4 rounded-xl text-white"
            />
            <input
              type="number"
              step="0.01"
              id="new-prezzo"
              placeholder="Prezzo Attuale"
              class="bg-slate-900 border border-slate-700 p-4 rounded-xl text-white"
            />
            <input
              type="number"
              id="new-qta"
              placeholder="QuantitÃ  Nominale"
              class="bg-slate-900 border border-slate-700 p-4 rounded-xl text-white"
            />
          </div>
          <div class="mt-8 flex gap-4">
            <button
              onclick="salvaNuovo()"
              class="flex-1 bg-emerald-500 text-white py-4 rounded-xl font-black shadow-lg"
            >
              SALVA
            </button>
            <button
              onclick="toggleForm()"
              class="flex-1 bg-slate-700 text-white py-4 rounded-xl font-black"
            >
              ANNULLA
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      const SB_URL = "https://xmwibmjbqcerxrkbepbh.supabase.co";
      const SB_KEY = "sb_publishable_f5oxVaJVgTEtmCRfnjeSng_GSAb5NoO";
      const client = supabase.createClient(SB_URL, SB_KEY);
      const MESI_NOMI = [
        "Gen",
        "Feb",
        "Mar",
        "Apr",
        "Mag",
        "Giu",
        "Lug",
        "Ago",
        "Set",
        "Ott",
        "Nov",
        "Dic",
      ];

      function getCol(t) {
        return (
          { CLARA: "blue", FEDERICO: "emerald", ANTONELLA: "purple" }[t] ||
          "slate"
        );
      }

      async function inizializza() {
        let p = prompt("Accesso:");
        if (p?.toLowerCase() === "milano") {
          document.getElementById("app").classList.remove("hidden");
          caricaDati();
        } else {
          document.body.innerHTML = "Accesso negato";
        }
      }

      async function caricaDati() {
        const [resP, resC] = await Promise.all([
          client.from("patrimonio").select("*").order("titolare"),
          client.from("conticorrenti").select("*").order("titolare"),
        ]);

        // Reset per evitare triplicazione
        const cT = document.getElementById("grid-container");
        const cC = document.getElementById("conti-container");
        const cF = document.getElementById("cashflow-container");
        cT.innerHTML = "";
        cC.innerHTML = "";
        cF.innerHTML = "";

        let totP = 0,
          totC = 0;
        let perU_Titoli = { CLARA: 0, FEDERICO: 0, ANTONELLA: 0 };
        let perU_Conti = { CLARA: 0, FEDERICO: 0, ANTONELLA: 0 };
        let flowMensile = Array(12).fill(0);

        // RENDER TITOLI
        resP.data?.forEach((r) => {
          const valAttuale =
            ((r.prezzo_unitario || 0) * (r.quantita || 0)) / 100;
          const pCarico = r.prezzo_di_carico || 100;
          const perf = ((r.prezzo_unitario - pCarico) / pCarico) * 100;

          totP += valAttuale;
          perU_Titoli[r.titolare] += valAttuale;
          const col = getCol(r.titolare);

          if (r.cedola_percentuale > 0 && r.mesi_stacco) {
            const mesi = r.mesi_stacco.split(",");
            const nettoMese =
              ((r.quantita * (r.cedola_percentuale / 100)) / mesi.length) *
              0.875;
            //console.log(`%c ðŸ’° CEDOLA: ${r.nome_asset}`, 'color: #fbbf24; font-weight: bold');
            //console.log(`%c ðŸ’° valore prima: ${nettoMese}`, 'color: #fbbf24; font-weight: bold');

            console.log(
              `--- Inizio elaborazione cedole per: ${r.nome_asset} ---`
            );
            mesi.forEach((m) => {
              const idx = parseInt(m) - 1;
              if (idx >= 0 && idx < 12) {
                // Log specifico della somma
                console.log(
                  `Mese: ${m} (${MESI_NOMI[idx]}) | Valore precedente: ${flowMensile[idx]} | Aggiungo: ${nettoMese}`
                );

                flowMensile[idx] += nettoMese;

                console.log(`Nuovo totale mese ${m}: ${flowMensile[idx]}`);
              }
            });

            //mesi.forEach(m => { flowMensile[parseInt(m)-1] += nettoMese; });
            //console.log(`%c ðŸ’° valore dopo: ${nettoMese}`, 'color: #fbbf24; font-weight: bold');
          }

          cT.innerHTML += `
                    <div class="glass border-l-8 border-${col}-500 rounded-[1.5rem] p-6 shadow-2xl card-enter relative group">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <span class="px-2 py-1 bg-${col}-500/10 text-${col}-400 text-[9px] font-black rounded uppercase">${
            r.titolare
          }</span>
                                <h3 class="text-white font-black text-xl uppercase mt-2 italic">${
                                  r.nome_asset
                                }</h3>
                                <p class="text-slate-500 font-mono text-[10px] uppercase">${
                                  r.isin
                                }</p>
                            </div>
                            <div class="text-right">
                                <span class="${
                                  perf >= 0
                                    ? "text-emerald-400"
                                    : "text-red-400"
                                } text-xs font-black bg-slate-900/80 px-2 py-1 rounded-lg border border-slate-700">
                                    ${perf >= 0 ? "+" : ""}${perf.toFixed(2)}%
                                </span>
                            </div>
                        </div>
                        <div class="my-6">
                            <h3 class="text-3xl font-black text-white">â‚¬ ${valAttuale.toLocaleString(
                              "it-IT",
                              { minimumFractionDigits: 2 }
                            )}</h3>
                        </div>
                        <div class="grid grid-cols-2 gap-4 bg-slate-900/60 p-4 rounded-xl mb-4 border border-slate-700/50">
                            <div><p class="text-[8px] font-black text-slate-500 uppercase mb-1">Cedola %</p>
                                <input type="number" step="0.01" value="${
                                  r.cedola_percentuale
                                }" onchange="aggCed('${
            r.isin
          }', this.value)" class="bg-transparent font-black text-amber-400 w-full outline-none text-sm"></div>
                            <div><p class="text-[8px] font-black text-slate-500 uppercase mb-1">Mesi</p>
                                <input type="text" value="${
                                  r.mesi_stacco || ""
                                }" onchange="aggMesi('${r.isin}', this.value,'${
            r.titolare
          }')" class="bg-transparent font-black text-white w-full outline-none text-sm"></div>

                                

                        </div>
                        <div class="grid grid-cols-3 gap-2">
                            <input type="number" step="0.01" value="${
                              r.prezzo_di_carico
                            }" onchange="aggCarico('${r.isin}', this.value,'${
            r.titolare
          }')" class="bg-slate-900/40 p-2 rounded text-center text-xs text-slate-300 outline-none">
                            <input type="number" step="0.01" value="${
                              r.prezzo_unitario
                            }" onchange="aggP('${r.isin}', this.value,'${
            r.titolare
          }')" class="bg-slate-900/40 p-2 rounded text-center text-xs text-white outline-none">
                            <input type="number" value="${
                              r.quantita
                            }" onchange="aggQ('${r.isin}', this.value,'${
            r.titolare
          }')" class="bg-slate-900/40 p-2 rounded text-center text-xs text-white outline-none">
                        </div>
                        <button onclick="elimina('${r.isin}','${
            r.titolare
          }')" class="mt-4 w-full text-slate-600 hover:text-red-500 text-[9px] font-black uppercase">Elimina Asset</button>
                    </div>`;
        });

        // RENDER CONTI
        resC.data?.forEach((c) => {
          totC += c.saldo || 0;
          perU_Conti[c.titolare] += c.saldo || 0;
          const col = getCol(c.titolare);
          cC.innerHTML += `
                    <div class="glass border-t-4 border-${col}-500/40 rounded-[1.5rem] p-6 shadow-lg hover:border-${col}-500 transition-all">
                        <div class="flex justify-between items-center mb-4">
                            <span class="px-2 py-1 bg-${col}-500/10 text-${col}-400 text-[9px] font-black rounded uppercase">${
            c.titolare
          }</span>
                            <span class="text-xs text-slate-500 font-black uppercase">${
                              c.istituto
                            }</span>
                        </div>
                        <h3 class="text-3xl font-black text-white italic">â‚¬ ${c.saldo.toLocaleString(
                          "it-IT"
                        )}</h3>
                        <button onclick="aggS('${c.id}', ${
            c.saldo
          })" class="mt-4 w-full py-2 bg-slate-900/50 hover:bg-slate-700 text-white text-[9px] font-black uppercase rounded-xl">Aggiorna Saldo</button>
                    </div>`;
        });

        // RENDER CASHFLOW
        flowMensile.forEach((val, i) => {
          const attivo =
            val > 0
              ? "border-amber-500/50 bg-amber-500/10"
              : "border-slate-800 opacity-20";
          cF.innerHTML += `<div class="border ${attivo} rounded-2xl p-4 text-center">
                    <p class="text-[10px] font-black uppercase text-slate-400 mb-1">${
                      MESI_NOMI[i]
                    }</p>
                    <p class="text-lg font-black ${
                      val > 0 ? "text-amber-400" : "text-slate-700"
                    }">â‚¬${val.toFixed(0)}</p>
                </div>`;
        });

        // Pulizia dei container delle card
        //document.getElementById('grid-container').innerHTML = "";
        //document.getElementById('conti-container').innerHTML = "";
        //document.getElementById('cashflow-container').innerHTML = "";

        // BARRE TOTALI SEZIONI
        creaBarra(totP, perU_Titoli, "blue", "grid-container", "Investimenti");
        creaBarra(totC, perU_Conti, "purple", "conti-container", "LiquiditÃ ");

        // HEADER TOTALS
        document.getElementById(
          "totale-display"
        ).innerHTML = `<span class="text-emerald-400">â‚¬ ${(
          totP + totC
        ).toLocaleString("it-IT")}</span>`;
        let ripHeader = "";
        for (let u in perU_Titoli) {
          const totU = perU_Titoli[u] + perU_Conti[u];
          ripHeader += `<div class="bg-slate-900 px-4 py-2 rounded-xl border border-slate-700 flex flex-col min-w-[120px]">
                    <span class="text-${getCol(
                      u
                    )}-400 font-black text-[9px]">${u}</span>
                    <span class="text-white font-bold">â‚¬${totU.toLocaleString(
                      "it-IT"
                    )}</span>
                </div>`;
        }
        document.getElementById("riepilogo-titolari").innerHTML = ripHeader;
      }

      function creaBarra(tot, perU, col, containerId, label) {
        const container = document.getElementById(containerId);
        if (!container) return;

        // Titolo della sezione (lo mettiamo PRIMA del container delle card)
        const wrapperId = "titolo-" + containerId;
        let wrapper = document.getElementById(wrapperId);

        // Se il wrapper non esiste, lo creiamo al volo sopra al container
        if (!wrapper) {
          container.insertAdjacentHTML(
            "beforebegin",
            `<div id="${wrapperId}" class="mb-6"></div>`
          );
          wrapper = document.getElementById(wrapperId);
        }

        // PULIZIA: Sovrascriviamo con "=" per eliminare la vecchia barra
        wrapper.innerHTML = `
        <div class="flex flex-wrap items-center gap-6 glass p-6 rounded-2xl border-l-4 border-${col}-500 shadow-xl card-enter">
            <div class="flex-1">
                <p class="text-[10px] font-black text-${col}-400 uppercase tracking-widest">Totale ${label}</p>
                <p class="text-3xl font-black italic tracking-tighter text-white">â‚¬ ${tot.toLocaleString(
                  "it-IT",
                  { minimumFractionDigits: 2 }
                )}</p>
            </div>
            <div class="flex gap-6 border-l border-slate-700/50 pl-6">
                ${Object.keys(perU)
                  .map(
                    (u) => `
                    <div>
                        <p class="text-[8px] font-black text-slate-500 uppercase">${u}</p>
                        <p class="text-sm font-bold text-white tracking-tight">â‚¬${perU[
                          u
                        ].toLocaleString("it-IT", {
                          maximumFractionDigits: 0,
                        })}</p>
                    </div>
                `
                  )
                  .join("")}
            </div>
        </div>`;
      }

      /* function creaBarra(tot, perU, col, targetId, label) {
            const bar = `
                <div class="flex flex-wrap gap-4 mb-8 p-5 glass border-l-4 border-${col}-500 rounded-2xl items-center card-enter">
                    <div class="flex-1">
                        <p class="text-[9px] font-black text-${col}-400 uppercase tracking-widest">Totale ${label}</p>
                        <p class="text-2xl font-black text-white italic">â‚¬ ${tot.toLocaleString('it-IT')}</p>
                    </div>
                    <div class="flex gap-4 border-l border-slate-700 pl-6">
                        ${Object.keys(perU).map(u => `<div class="flex flex-col"><span class="text-[8px] font-black text-slate-500">${u}</span><span class="text-xs font-bold text-white">â‚¬${perU[u].toLocaleString('it-IT')}</span></div>`).join('')}
                    </div>
                </div>`;
            document.getElementById(targetId).insertAdjacentHTML('beforebegin', bar);
        }
                */

      // Funzioni Supabase
      async function salvaNuovo() {
        const data = {
          isin: document.getElementById("new-isin").value,
          nome_asset: document.getElementById("new-nome").value,
          quantita: parseFloat(document.getElementById("new-qta").value),
          prezzo_unitario: parseFloat(
            document.getElementById("new-prezzo").value
          ),
          prezzo_di_carico: parseFloat(
            document.getElementById("new-carico").value
          ),
          cedola_percentuale: parseFloat(
            document.getElementById("new-cedola").value
          ),
          mesi_stacco: document.getElementById("new-mesi").value,
          titolare: document.getElementById("new-titolare").value,
          ultimo_aggiornamento: new Date(),
        };
        await client.from("patrimonio").insert([data]);

        toggleForm();
        caricaDati();
      }

      async function aggCed(isin, v) {
        await client
          .from("patrimonio")
          .update({ cedola_percentuale: parseFloat(v) })
          .eq("isin", isin);
        caricaDati();
      }
      //async function aggMesi(isin, v) { await client.from('patrimonio').update({ mesi_stacco: v }).eq('isin', isin); caricaDati(); }

      async function aggMesi(isin, v, titolare) {
        // Aggiungiamo il filtro .eq('titolare', titolare) per colpire solo la riga giusta
        await client
          .from("patrimonio")
          .update({ mesi_stacco: v })
          .eq("isin", isin)
          .eq("titolare", titolare);

        console.log(`Aggiornati mesi per ${isin} di ${titolare}`);
        caricaDati();
      }

      async function aggP(isin, v, titolare) {
        await client
          .from("patrimonio")
          .update({
            prezzo_unitario: parseFloat(v),
            ultimo_aggiornamento: new Date(),
          })
          .eq("isin", isin)
          .eq("titolare", titolare);
        caricaDati();
      }
      async function aggQ(isin, v, titolare) {
        await client
          .from("patrimonio")
          .update({ quantita: parseFloat(v) })
          .eq("isin", isin)
          .eq("titolare", titolare);
        caricaDati();
      }
      async function aggCarico(isin, v, titolare) {
        await client
          .from("patrimonio")
          .update({ prezzo_di_carico: parseFloat(v) })
          .eq("isin", isin)
          .eq("titolare", titolare);
        caricaDati();
      }
      async function aggS(id, att) {
        let n = prompt("Nuovo saldo:", att);
        if (n) {
          await client
            .from("conticorrenti")
            .update({ saldo: parseFloat(n.replace(",", ".")) })
            .eq("id", id);
          caricaDati();
        }
      }
      async function elimina(isin, titolare) {
        if (confirm("Eliminare?")) {
          await client
            .from("patrimonio")
            .delete()
            .eq("isin", isin)
            .eq("titolare", titolare);
          caricaDati();
        }
      }
      function toggleForm() {
        document.getElementById("form-aggiunta").classList.toggle("hidden");
      }
      window.onload = inizializza;
    </script>
  </body>
</html>
