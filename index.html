<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patrimonio Pro - Calcolo Esatto</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-[#0f172a] text-slate-200 p-4 md:p-8 font-sans">

    <div id="app" class="max-w-6xl mx-auto hidden">
        <header class="mb-10 flex flex-col md:flex-row justify-between items-center gap-6 bg-slate-800/40 p-6 rounded-3xl border border-slate-700/50 shadow-2xl">
            <div>
                <h1 class="text-3xl font-black text-white italic uppercase tracking-tighter">ðŸ’° PATRIMONIO GESTITO</h1>
                <div id="totale-display" class="mt-2 text-4xl font-black tracking-tighter text-white">---</div>
                <div id="riepilogo-titolari" class="mt-4 flex flex-wrap gap-3"></div>
            </div>
            <button onclick="toggleForm()" class="bg-blue-500 hover:bg-blue-400 text-white px-8 py-4 rounded-2xl font-black shadow-xl transition-all">NUOVO ASSET</button>
        </header>

        <section class="mb-12 bg-slate-900/40 border border-slate-800 rounded-3xl p-6 shadow-inner">
            <h2 class="text-[10px] font-black text-slate-500 mb-6 uppercase tracking-[0.4em] flex items-center gap-2">
                <span class="w-2 h-2 rounded-full bg-amber-500 animate-pulse"></span> Cedole Nette (Tassa 12.5% applicata)
            </h2>
            <div id="cashflow-container" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 text-center"></div>
        </section>

        <div id="grid-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 mb-16"></div>
        <div id="conti-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 pb-20"></div>
    </div>

    <script>
        const SB_URL = "https://xmwibmjbqcerxrkbepbh.supabase.co";
        const SB_KEY = "sb_publishable_f5oxVaJVgTEtmCRfnjeSng_GSAb5NoO";
        const client = supabase.createClient(SB_URL, SB_KEY);
        const MESI_NOMI = ["Gen", "Feb", "Mar", "Apr", "Mag", "Giu", "Lug", "Ago", "Set", "Ott", "Nov", "Dic"];

        function getCol(t) { return {'CLARA':'blue','FEDERICO':'emerald','ANTONELLA':'purple'}[t] || 'slate'; }

        async function inizializza() {
            let p = prompt("Accesso:");
            if (p?.toLowerCase() === "milano") {
                document.getElementById('app').classList.remove('hidden');
                caricaDati();
            } else { document.body.innerHTML = "Accesso negato."; }
        }

        async function caricaDati() {
            const [resP, resC] = await Promise.all([
                client.from('patrimonio').select('*').order('titolare'),
                client.from('conticorrenti').select('*').order('titolare')
            ]);

            const cT = document.getElementById('grid-container');
            const cC = document.getElementById('conti-container');
            const cF = document.getElementById('cashflow-container');
            
            // RESET TOTALE DEI CONTENITORI PER EVITARE DUPLICAZIONI
            cT.innerHTML = ""; cC.innerHTML = ""; cF.innerHTML = "";
            let flowMensile = Array(12).fill(0);
            let totP = 0, totC = 0, perU = {'CLARA':0, 'FEDERICO':0, 'ANTONELLA':0};

            resP.data?.forEach(r => {
                const nominale = parseFloat(r.quantita) || 0;
                const prAtt = parseFloat(r.prezzo_unitario) || 0;
                const prCar = parseFloat(r.prezzo_di_carico) || 100;
                const cedPerc = parseFloat(r.cedola_percentuale) || 0;

                // 1. VALORE DI MERCATO
                const valMercato = (nominale * prAtt) / 100;
                totP += valMercato;
                perU[r.titolare] += valMercato;

                // 2. CALCOLO CEDOLA (70000 * 2% * 0.875 = 1225)
                if(cedPerc > 0 && r.mesi_stacco) {
                    const mesiArr = String(r.mesi_stacco).split(',').map(m => parseInt(m.trim())).filter(m => !isNaN(m));
                    if(mesiArr.length > 0) {
                        const cedolaNettaTotaleAnnua = (nominale * (cedPerc / 100)) * 0.875;
                        const singolaCedola = cedolaNettaTotaleAnnua / mesiArr.length;
                        
                        mesiArr.forEach(m => {
                            if(m >= 1 && m <= 12) flowMensile[m-1] += singolaCedola;
                        });
                    }
                }

                const col = getCol(r.titolare);
                const perf = ((prAtt - prCar) / prCar) * 100;

                cT.innerHTML += `
                    <div class="bg-slate-800 border-l-4 border-${col}-500 rounded-3xl p-6 shadow-xl relative">
                        <div class="flex justify-between items-start mb-4">
                            <span class="px-2 py-1 bg-slate-900 text-${col}-400 text-[10px] font-bold rounded border border-slate-700 uppercase">${r.titolare}</span>
                            <span class="font-bold text-${perf >= 0 ? 'emerald' : 'red'}-400 text-xs">${perf >= 0 ? '+' : ''}${perf.toFixed(2)}%</span>
                        </div>
                        <h3 class="text-white font-black text-lg uppercase truncate mb-1">${r.nome_asset}</h3>
                        <p class="text-[9px] text-slate-500 uppercase font-black mb-1">Controvalore</p>
                        <h3 class="text-2xl font-black text-white italic mb-4">â‚¬ ${valMercato.toLocaleString('it-IT', {minimumFractionDigits: 2})}</h3>
                        
                        <div class="grid grid-cols-2 gap-2 bg-slate-900/50 p-3 rounded-xl mb-4">
                            <div><p class="text-slate-500 text-[8px] uppercase font-black">Cedola %</p>
                                 <input type="number" step="0.01" value="${cedPerc}" onchange="agg('cedola_percentuale','${r.isin}',this.value)" class="bg-transparent text-amber-400 font-bold w-full outline-none"></div>
                            <div><p class="text-slate-500 text-[8px] uppercase font-black">Mesi</p>
                                 <input type="text" value="${r.mesi_stacco}" onchange="agg('mesi_stacco','${r.isin}',this.value)" class="bg-transparent text-white font-bold w-full outline-none"></div>
                        </div>

                        <div class="grid grid-cols-3 gap-2 text-center text-[10px]">
                            <div><p class="text-slate-500">CARICO</p><input type="number" step="0.01" value="${prCar}" onchange="agg('prezzo_di_carico','${r.isin}',this.value)" class="bg-transparent text-white w-full text-center outline-none"></div>
                            <div><p class="text-slate-500">ATTUALE</p><input type="number" step="0.01" value="${prAtt}" onchange="agg('prezzo_unitario','${r.isin}',this.value)" class="bg-transparent text-white w-full text-center outline-none"></div>
                            <div><p class="text-slate-500">NOMINALE</p><input type="number" value="${nominale}" onchange="agg('quantita','${r.isin}',this.value)" class="bg-transparent text-white w-full text-center outline-none"></div>
                        </div>
                    </div>`;
            });

            // RENDER CALENDARIO
            flowMensile.forEach((val, i) => {
                const isAttivo = val > 0;
                cF.innerHTML += `
                    <div class="p-4 rounded-2xl border ${isAttivo ? 'border-amber-500/50 bg-amber-500/5 shadow-lg' : 'border-slate-800 opacity-30'}">
                        <p class="text-[10px] font-bold text-slate-500 uppercase">${MESI_NOMI[i]}</p>
                        <p class="text-lg font-black ${isAttivo ? 'text-amber-400' : 'text-slate-700'}">â‚¬${val.toLocaleString('it-IT', {maximumFractionDigits: 0})}</p>
                    </div>`;
            });

            // CONTI CORRENTI
            resC.data?.forEach(c => {
                totC += c.saldo; perU[c.titolare] += c.saldo;
                cC.innerHTML += `<div class="bg-slate-800/40 border border-slate-700 p-6 rounded-3xl flex justify-between items-center">
                    <div><p class="text-[10px] text-${getCol(c.titolare)}-400 font-bold uppercase">${c.titolare}</p><h3 class="text-xl font-bold text-white">â‚¬${c.saldo.toLocaleString('it-IT')}</h3></div>
                    <button onclick="aggSaldo('${c.id}',${c.saldo})" class="text-slate-500 hover:text-white font-bold text-xs">EDIT</button>
                </div>`;
            });

            document.getElementById('totale-display').innerText = "â‚¬ " + (totP + totC).toLocaleString('it-IT', {minimumFractionDigits: 2});
            document.getElementById('riepilogo-titolari').innerHTML = Object.keys(perU).map(u => `
                <div class="bg-slate-800 px-3 py-1 rounded-xl border border-slate-700 text-xs font-bold uppercase">
                    <span class="text-${getCol(u)}-400">${u}:</span> â‚¬${perU[u].toLocaleString('it-IT', {maximumFractionDigits:0})}
                </div>`).join('');
        }

        // FUNZIONE UNICA AGGIORNAMENTO
        async function agg(campo, isin, val) {
            const up = {}; up[campo] = (campo === 'mesi_stacco') ? val : parseFloat(val);
            await client.from('patrimonio').update(up).eq('isin', isin);
            caricaDati();
        }

        async function aggSaldo(id, attuale) {
            let n = prompt("Nuovo saldo:", attuale);
            if(n) { await client.from('conticorrenti').update({saldo: parseFloat(n)}).eq('id', id); caricaDati(); }
        }

        function toggleForm() { /* ... */ }
        window.onload = inizializza;
    </script>
</body>
</html>
