<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Patrimonio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-slate-900 text-white p-10">

    <h1 class="text-2xl mb-4 text-emerald-400 font-bold">Stato Sistema:</h1>
    <div id="debug-log" class="bg-black p-4 font-mono text-sm border border-slate-700 rounded-lg mb-6">
        Attendere...
    </div>

    <div id="dashboard" class="hidden">
        <h2 class="text-xl mb-4">Dati Portafoglio:</h2>
        <div id="tabella" class="space-y-2"></div>
    </div>

    <script>
        const log = document.getElementById('debug-log');
        
        // Funzione per scrivere gli errori sullo schermo del tablet
        function scrivi(msg) {
            log.innerHTML += "<br>> " + msg;
        }

        async function esegui() {
            try {
                scrivi("Fase 1: Avvio script...");

                // --- CONFIGURAZIONE ---
                const SB_URL = "https://xmwibmjbqcerxrkbepbh.supabase.co";

        const SB_KEY =  "sb_publishable_f5oxVaJVgTEtmCRfnjeSng_GSAb5NoO";
                const MIA_PASS = "LA_TUA_PASS_QUI";
                // ----------------------

                scrivi("Fase 2: Controllo credenziali...");
                if(SB_URL.includes("URL_QUI")) {
                    scrivi("ERRORE: Non hai sostituito l'URL di Supabase!");
                    return;
                }

                const pass = prompt("Inserisci la password:");
                if (pass !== MIA_PASS) {
                    scrivi("ERRORE: Password errata.");
                    return;
                }
                scrivi("Fase 3: Password OK. Connessione a Supabase...");

                const supabaseClient = supabase.createClient(SB_URL, SB_KEY);
                
                const { data, error } = await supabaseClient.from('patrimonio').select('*');

                if (error) {
                    scrivi("ERRORE SUPABASE: " + error.message);
                    return;
                }

                scrivi("Fase 4: Dati ricevuti! Totale righe: " + data.length);
                
                document.getElementById('dashboard').classList.remove('hidden');
                let lista = "";
                data.forEach(r => {
                    lista += `<div class='p-2 bg-slate-800 rounded'>${r.isin}: ${r.prezzo}â‚¬</div>`;
                });
                document.getElementById('tabella').innerHTML = lista;
                scrivi("Fase 5: Operazione completata con successo.");

            } catch (err) {
                scrivi("ERRORE CRITICO: " + err.message);
            }
        }

        // Lanciamo l'esecuzione
        esegui();
    </script>
</body>
</html>





























<!DOCTYPE html>
<html lang="it">
<head>
    <meta name="robots" content="noindex, nofollow">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mio Patrimonio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-[#0f172a] text-slate-200 font-sans p-8">

    <div id="loading" class="text-center mt-20 text-xl font-bold">
        Verifica accesso in corso...
    </div>

    <div id="content" class="max-w-5xl mx-auto hidden">
        <header class="mb-10 text-center">
            <h1 class="text-4xl font-bold text-emerald-400">ðŸ“Š Portafoglio BTP</h1>
            <p id="last-update" class="text-slate-400 mt-2">Dati aggiornati via GitHub Actions</p>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-10">
            <div class="bg-slate-800 p-6 rounded-2xl border border-slate-700 shadow-xl">
                <p class="text-xs text-slate-400 uppercase mb-1">Valore Totale</p>
                <h2 id="totale-valore" class="text-3xl font-bold text-white">â‚¬ 0.00</h2>
            </div>
            <div class="bg-slate-800 p-6 rounded-2xl border border-slate-700 shadow-xl">
                <p class="text-xs text-slate-400 uppercase mb-1">P&L Totale</p>
                <h2 id="totale-guadagno" class="text-3xl font-bold text-white">â‚¬ 0.00</h2>
            </div>
        </div>

        <div class="bg-slate-800 rounded-2xl border border-slate-700 overflow-hidden shadow-xl">
            <table class="w-full text-left">
                <thead class="bg-slate-700 text-slate-300 uppercase text-xs">
                    <tr>
                        <th class="p-4">ISIN</th>
                        <th class="p-4 text-right">Prezzo</th>
                        <th class="p-4 text-right">Totale</th>
                        <th class="p-4 text-right">P&L</th>
                    </tr>
                </thead>
                <tbody id="tabella-corpo" class="divide-y divide-slate-700"></tbody>
            </table>
        </div>
    </div>

    <script>
        // --- CONFIGURAZIONE ---
        const SB_URL = "https://xmwibmjbqcerxrkbepbh.supabase.co";

        const SB_KEY =  "sb_publishable_f5oxVaJVgTEtmCRfnjeSng_GSAb5NoO";
        const PASS_CORRETTA = "TUA_PASSWORD"; // Sostituisci con la tua password
        // ----------------------

        const supabaseClient = supabase.createClient(SB_URL, SB_KEY);

        async function avvia() {
            const passUtente = prompt("Inserisci la password:");
            
            if (passUtente !== PASS_CORRETTA) {
                alert("Accesso negato.");
                document.getElementById('loading').innerText = "ACCESSO NEGATO";
                return;
            }

            document.getElementById('loading').classList.add('hidden');
            document.getElementById('content').classList.remove('hidden');
            
            try {
                const { data, error } = await supabaseClient.from('patrimonio').select('*');
                
                if (error) throw error;

                let html = "";
                let tValore = 0;
                let tCarico = 0;

                data.forEach(r => {
                    const valore = (r.prezzo || 0) * (r.quantita || 0);
                    const carico = (r.prezzo_carico || 0) * (r.quantita || 0);
                    const pnl = valore - carico;
                    
                    tValore += valore;
                    tCarico += carico;

                    html += `
                        <tr class="hover:bg-slate-750">
                            <td class="p-4 font-mono font-bold">${r.isin}</td>
                            <td class="p-4 text-right">${r.prezzo.toFixed(2)}â‚¬</td>
                            <td class="p-4 text-right font-bold">${valore.toFixed(2)}â‚¬</td>
                            <td class="p-4 text-right ${pnl >= 0 ? 'text-emerald-400' : 'text-red-400'}">
                                ${pnl >= 0 ? '+' : ''}${pnl.toFixed(2)}â‚¬
                            </td>
                        </tr>
                    `;
                });

                document.getElementById('tabella-corpo').innerHTML = html;
                document.getElementById('totale-valore').innerText = `â‚¬ ${tValore.toFixed(2)}`;
                document.getElementById('totale-guadagno').innerText = `â‚¬ ${(tValore - tCarico).toFixed(2)}`;
                document.getElementById('totale-guadagno').classList.add(tValore - tCarico >= 0 ? 'text-emerald-400' : 'text-red-400');
            } catch (err) {
                console.error(err);
                alert("Errore nel caricamento dati. Controlla la console.");
            }
        }

        window.onload = avvia;
    </script>
</body>
</html>
